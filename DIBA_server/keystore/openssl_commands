# Update openssl default values
sudo vim /etc/pki/tls/openssl.cnf

# Generate DIBA CA private key
openssl genrsa -out DIBA_CA.key 2048

# Generate DIBA CA certificate (15 years validity)
openssl req -x509 -new -key DIBA_CA.key -sha256 -days 5475 -out DIBA_CA.pem

# Generate DIBA Server private key
openssl genrsa -out DIBA_Server.key 2048

# Generate DIBA Server CSR
openssl req -new -key DIBA_Server.key -out DIBA_Server.csr

# Generate certificate from CSR (14 years validity)
openssl x509 -req -in DIBA_Server.csr -CA DIBA_CA.pem -CAkey DIBA_CA.key -CAcreateserial -out DIBA_Server.crt -days 5110 -sha256

# Generate pkcs12 certificate from DIBA CA private key and DIBA CA certificate. To be imported in keystore
openssl pkcs12 -export -in DIBA_CA.pem -inkey DIBA_CA.key -out DIBA_CA.p12

# Create keystore from CA p12 
keytool -importkeystore -srckeystore DIBA_CA.p12 -srcstoretype pkcs12 -destkeystore keystore.jks -deststoretype pkcs12

# Convert the x.509 cert and key to a pkcs12 file
openssl pkcs12 -export -in DIBA_Server.crt -inkey DIBA_Server.key -out DIBA_Server.p12

# Import p12 to keystore
keytool -importkeystore -srckeystore DIBA_Server.p12 -srcstoretype pkcs12 -destkeystore keystore.jks -deststoretype pkcs12

# List keystore entries
keytool -list -v -keystore keystore.jks

# Pinning DIBA CA public key to application
cp DIBA_CA.pem DIBA/DIBA_app/app/src/main/res/raw/ca_cert
# Pinning DIBA Server public key to application
cp DIBA_Server.crt DIBA/DIBA_app/app/src/main/res/raw/diba_cert

# Install CA public key in trusted CA of device
adb push DIBA_CA.pem /sdcard/
Settings -> Security -> Encryption & Credentials -> Install from SD card -> Select DIBA_CA.pem

